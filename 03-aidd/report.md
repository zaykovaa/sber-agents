# Отчет о выполнении задания

## Название проекта и краткое описание

**Telegram Bot - Эксперт кино** — Telegram-бот с интеграцией LLM, который ведет диалог с пользователями в роли профессионального эксперта по кино и сериалам. Бот помогает пользователям находить идеальный фильм или сериал для просмотра, узнавать о последних трендах и релизах, получать рекомендации по жанрам и обсуждать кинематографические шедевры. Реализован с использованием асинхронного фреймворка aiogram 3.x и интеграции с LLM через OpenRouter API.

## Выбранная роль ИИ-ассистента и обоснование

**Роль: AI-coding ассистент (Code Generation Assistant)**

**Обоснование:**
- Проект требует написания кода с нуля: интеграция Telegram Bot API, работа с асинхронным кодом, взаимодействие с LLM API
- Необходима генерация структурированного Python-кода с соблюдением принципов KISS и YAGNI
- Требуется помощь в правильной настройке асинхронных операций (async/await) и интеграции с внешними API
- AI-ассистент помогает быстро прототипировать функциональность, генерировать обработчики сообщений и корректно работать с историей диалогов
- При разработке возникли проблемы с запуском бота (отсутствие точки входа, неправильное использование async/await), которые были решены с помощью AI-ассистента

## Реализованные возможности

- [x] Базовая интеграция с Telegram Bot API через aiogram 3.x
- [x] Команда `/start` — приветствие и инициализация новой сессии
- [x] Команда `/help` — справка по использованию бота
- [x] Команда `/clear` — очистка истории диалога пользователя
- [x] Интеграция с LLM через OpenRouter API (поддержка различных моделей)
- [x] Системный промпт для определения роли бота как "Эксперт кино"
- [x] История диалога для каждого пользователя (in-memory storage)
- [x] Ограничение длины истории диалога (настраиваемый параметр MAX_HISTORY_MESSAGES)
- [x] Обработка текстовых сообщений с генерацией ответов через LLM
- [x] Многопользовательская поддержка (отдельная история для каждого пользователя)
- [x] Логирование основных событий (запуск, сообщения, ошибки)
- [x] Статистика использования (количество пользователей и сообщений)
- [x] Обработка ошибок при недоступности LLM
- [x] Конфигурация через переменные окружения (.env файл)
- [x] Асинхронная архитектура (async/await для всех операций)

## Технологический стек

### Основные технологии
- **Python 3.10+** — основной язык разработки
- **aiogram 3.x** — современный асинхронный фреймворк для Telegram Bot API
- **OpenRouter API** — агрегатор LLM API для доступа к различным моделям (GPT-3.5, GPT-4 и др.)
- **OpenAI Python SDK** — клиент для работы с LLM через OpenRouter
- **python-dotenv** — загрузка конфигурации из .env файла
- **uv** — современный менеджер зависимостей Python (быстрая альтернатива pip)

### Инструменты разработки
- **Make** — автоматизация рутинных команд (setup, run, clean)
- **Git** — контроль версий
- **pyproject.toml** — конфигурация проекта и зависимостей

### Принципы архитектуры
- **KISS (Keep It Simple, Stupid)** — простая архитектура, минимум абстракций
- **YAGNI (You Aren't Gonna Need It)** — реализация только необходимого функционала
- **Async/await** — полностью асинхронный код для эффективности
- **In-memory storage** — история диалогов хранится в памяти (без БД)

## Инструменты AI-driven разработки

### Используемая AI-coding IDE
**Cursor** — AI-powered IDE с интеграцией LLM для генерации и редактирования кода в реальном времени.

### Используемые LLM модели для генерации документации и кода
- **GPT-4 / GPT-3.5-turbo** (через Cursor IDE) — для генерации кода, рефакторинга, исправления ошибок и написания документации
- **OpenRouter API** (в боте) — для генерации ответов пользователям, используется модель `openai/gpt-3.5-turbo` по умолчанию (настраивается через конфигурацию)

### Использование AI в процессе разработки
- Генерация структуры проекта и базового кода бота
- Создание обработчиков команд и сообщений
- Рефакторинг и исправление ошибок (например, исправление проблемы с async/await при запуске бота)
- Генерация документации (README.md, vision.md)
- Помощь в отладке и решении проблем с запуском

## Скриншот работы

![Скриншот работы бота](screenshots/WhatsApp%20Image%202025-11-04%20at%2016.58.43.jpeg)

## Процесс разработки: основные вызовы и решения

### Вызов 1: Правильная настройка асинхронного кода
**Проблема:** При запуске бота возникала ошибка `RuntimeError: Task got Future attached to a different loop` из-за неправильного использования `asyncio.run()` с методом `start_polling()`.

**Решение:** Преобразовал метод `run()` в асинхронный (`async def run`) и создал отдельную функцию `main()` для правильной инициализации event loop. Теперь используется правильный паттерн:
```python
async def main():
    bot = FilmExpertBot()
    await bot.run()

if __name__ == "__main__":
    asyncio.run(main())
```

### Вызов 2: Отсутствие точки входа
**Проблема:** Изначально в файле `bot.py` не было блока `if __name__ == "__main__":`, поэтому бот нельзя было запустить напрямую.

**Решение:** Добавлен блок запуска с созданием экземпляра класса и вызовом метода `run()`.

### Вызов 3: Интеграция с OpenRouter API
**Проблема:** Необходимо было правильно настроить клиент OpenAI SDK для работы с OpenRouter API через кастомный `base_url`.

**Решение:** Использован `AsyncOpenAI` с параметром `base_url`, указывающим на OpenRouter API endpoint. Это позволяет использовать стандартный OpenAI SDK с альтернативным провайдером.

### Вызов 4: Управление историей диалогов
**Проблема:** Необходимо сохранять контекст разговора для каждого пользователя, ограничивать длину истории и правильно обрабатывать системный промпт.

**Решение:** Реализована структура `Dict[int, List[Dict[str, str]]]` для хранения истории каждого пользователя. Системный промпт добавляется автоматически при первом обращении пользователя и сохраняется при очистке истории. Реализована логика ограничения длины истории с сохранением системного промпта.

### Вызов 5: Обработка ошибок
**Проблема:** При недоступности LLM или ошибках API бот мог завершить работу.

**Решение:** Добавлена обработка исключений в методе `generate_response()` с логированием ошибок и возвратом понятного сообщения пользователю. Бот продолжает работу даже при ошибках LLM.

## Что узнал нового в процессе AI-driven разработки

1. **Эффективность AI-ассистента в быстром прототипировании**: Cursor IDE значительно ускорил процесс разработки, позволяя генерировать структуру кода, обработчики и базовую логику за считанные минуты вместо часов ручного написания.

2. **Важность правильного понимания async/await в Python**: При работе с асинхронными фреймворками (aiogram) критически важно правильно инициализировать event loop и использовать await для асинхронных операций. AI-ассистент помог быстро найти и исправить ошибку с event loop.

3. **Интеграция различных API через единый интерфейс**: OpenRouter API позволяет использовать стандартный OpenAI SDK для доступа к различным LLM моделям, что упрощает интеграцию и делает код более универсальным.

4. **Принципы KISS и YAGNI в AI-driven разработке**: AI-ассистент может генерировать избыточный код, поэтому важно четко формулировать требования и следовать принципам простоты. Это помогает избежать переусложнения архитектуры.

5. **Итеративный процесс разработки с AI**: AI-ассистент отлично работает в режиме итераций: сначала генерируется базовая версия, затем она тестируется, находятся проблемы, и AI помогает их исправить. Это создает эффективный цикл разработки.

## (Опционально) Ссылка на работающего бота

Бот настроен и готов к запуску. Для работы необходимо:
1. Создать файл `.env` с токенами `TELEGRAM_BOT_TOKEN` и `OPENROUTER_API_KEY`
2. Запустить бота командой `make run` или `uv run python src/bot.py`
3. Найти бота в Telegram по имени, указанному при создании через @BotFather

---

**Автор:** Зайкова Анастасия Тимуровна  
**Проект:** 03-aidd - AI-driven разработка с ИИ-агентами  
**Дата:** Ноябрь 2024

